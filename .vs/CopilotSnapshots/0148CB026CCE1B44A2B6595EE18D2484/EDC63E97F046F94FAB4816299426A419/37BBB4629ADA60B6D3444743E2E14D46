@page "/ai-write"
@using BlogApp.Shared.Models.AI
@inject IAIContentService AIContentService
@inject IBlogService BlogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>AI Write - BlogApp</PageTitle>

<div class="medium-ai-container">
    <div class="medium-ai-form">
        <h2 class="medium-ai-title">AI Content Generator</h2>
        <form>
            <div class="medium-ai-field">
                <label for="topic">Topic</label>
                <input id="topic" type="text" class="medium-ai-input" @bind="request.Topic" required />
            </div>
            <div class="medium-ai-field">
                <label for="context">Additional Context (Optional)</label>
                <textarea id="context" class="medium-ai-input" @bind="request.AdditionalContext" rows="3"></textarea>
            </div>
            <div class="medium-ai-field">
                <label for="type">Content Type</label>
                <select id="type" class="medium-ai-input" @bind="request.Type">
                    <option value="ContentType.BlogPost">Blog Post</option>
                    <option value="ContentType.Tutorial">Tutorial</option>
                    <option value="ContentType.Article">Article</option>
                    <option value="ContentType.News">News</option>
                    <option value="ContentType.Review">Review</option>
                    <option value="ContentType.Opinion">Opinion</option>
                </select>
            </div>
            <div class="medium-ai-field">
                <label for="style">Writing Style</label>
                <select id="style" class="medium-ai-input" @bind="request.Style">
                    <option value="WritingStyle.Professional">Professional</option>
                    <option value="WritingStyle.Casual">Casual</option>
                    <option value="WritingStyle.Academic">Academic</option>
                    <option value="WritingStyle.Creative">Creative</option>
                    <option value="WritingStyle.Technical">Technical</option>
                    <option value="WritingStyle.Conversational">Conversational</option>
                </select>
            </div>
            <div class="medium-ai-field">
                <label for="targetLength">Target Length (words)</label>
                <input id="targetLength" type="number" class="medium-ai-input" @bind="request.TargetLength" />
            </div>
            <div class="medium-ai-field">
                <label for="targetAudience">Target Audience (Optional)</label>
                <input id="targetAudience" type="text" class="medium-ai-input" @bind="request.TargetAudience" />
            </div>
            <div class="medium-ai-checkbox">
                <input id="includeImages" type="checkbox" @bind="request.IncludeImages" />
                <label for="includeImages">Include image suggestions</label>
            </div>
            <div class="medium-ai-checkbox">
                <input id="includeCodeExamples" type="checkbox" @bind="request.IncludeCodeExamples" />
                <label for="includeCodeExamples">Include code examples</label>
            </div>
            <button type="button" class="medium-btn medium-btn-primary medium-ai-btn" @onclick="GenerateContent" disabled="@isGenerating">
                @if (isGenerating)
                {
                    <span class="medium-auth-spinner"></span>
                }
                Generate Content
            </button>
        </form>
    </div>
    <div class="medium-ai-preview">
        @if (isGenerating)
        {
            <div class="medium-ai-loading">
                <span class="medium-auth-spinner"></span>
                <span>Generating your content...</span>
            </div>
        }
        else if (generatedContent != null)
        {
            <div class="medium-ai-content">
                <h3>@generatedContent.Title</h3>
                <p>@generatedContent.Excerpt</p>
                <div class="medium-ai-tags">
                    @foreach (var tag in generatedContent.SuggestedTags)
                    {
                        <span class="medium-ai-tag">@tag</span>
                    }
                </div>
                <div class="medium-ai-body">
                    @((MarkupString)generatedContent.GeneratedContent.Replace("\n", "<br/>") )
                </div>
                <div class="medium-ai-actions">
                    <button type="button" class="medium-btn medium-btn-primary" @onclick="CreatePost">Create Post</button>
                    <button type="button" class="medium-btn medium-btn-outline" @onclick="RegenerateContent">Regenerate</button>
                </div>
            </div>
        }
        else
        {
            <div class="medium-ai-empty">
                <span>Fill in the form and click "Generate Content" to get started.</span>
            </div>
        }
    </div>
</div>

@code {
    private ContentGenerationRequest request = new();
    private ContentGenerationResponse? generatedContent;
    private bool isGenerating = false;

    private async Task GenerateContent()
    {
        if (string.IsNullOrWhiteSpace(request.Topic)) return;
        isGenerating = true;
        try
        {
            generatedContent = await AIContentService.GenerateContentAsync(request);
            Snackbar.Add("Content generated successfully!", Severity.Success);
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to generate content. Please try again.", Severity.Error);
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task CreatePost()
    {
        if (generatedContent == null) return;
        try
        {
            var createRequest = new CreatePostRequest
            {
                Title = generatedContent.Title,
                Excerpt = generatedContent.Excerpt,
                Content = generatedContent.GeneratedContent,
                Tags = generatedContent.SuggestedTags,
                Categories = generatedContent.SuggestedCategories,
                IsAIGenerated = true,
                AIPrompt = request.Topic
            };
            var post = await BlogService.CreatePostAsync(createRequest);
            Snackbar.Add("Post created successfully!", Severity.Success);
            Navigation.NavigateTo($"/post/{post.Slug}");
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to create post. Please try again.", Severity.Error);
        }
    }

    private async Task RegenerateContent()
    {
        await GenerateContent();
    }
}

<style>
.medium-ai-container {
    display: flex;
    gap: 2rem;
    max-width: 1100px;
    margin: 2rem auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.03);
    padding: 2rem;
}
.medium-ai-form {
    flex: 1;
    padding-right: 2rem;
    border-right: 1px solid #eee;
}
.medium-ai-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
}
.medium-ai-field {
    margin-bottom: 1.2rem;
}
.medium-ai-field label {
    display: block;
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #222;
}
.medium-ai-input {
    width: 100%;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    border: 1px solid #eee;
    font-size: 1rem;
    background: #fafafa;
    color: #222;
    transition: border 0.2s;
}
.medium-ai-input:focus {
    border-color: #1a8917;
    outline: none;
}
.medium-ai-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    margin-bottom: 1rem;
}
.medium-ai-btn {
    width: 100%;
    margin-top: 0.5rem;
}
.medium-ai-preview {
    flex: 2;
    padding-left: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}
.medium-ai-loading {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.1rem;
    color: #1a8917;
    margin-top: 2rem;
}
.medium-ai-content {
    margin-top: 1rem;
    background: #fafafa;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 8px rgba(0,0,0,0.04);
}
.medium-ai-content h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}
.medium-ai-tags {
    margin-bottom: 1rem;
}
.medium-ai-tag {
    display: inline-block;
    background: #1a8917;
    color: #fff;
    border-radius: 12px;
    padding: 0.2rem 0.8rem;
    font-size: 0.95rem;
    margin-right: 0.5rem;
    margin-bottom: 0.3rem;
}
.medium-ai-body {
    font-size: 1rem;
    color: #222;
    margin-bottom: 1.5rem;
    line-height: 1.7;
}
.medium-ai-actions {
    display: flex;
    gap: 1rem;
}
.medium-ai-empty {
    margin-top: 2rem;
    color: #888;
    font-size: 1.1rem;
}
.medium-auth-spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #eee;
    border-top: 2px solid #1a8917;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}
keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
