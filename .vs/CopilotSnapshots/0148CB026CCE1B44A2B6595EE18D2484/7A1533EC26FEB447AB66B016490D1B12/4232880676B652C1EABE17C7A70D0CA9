using BlogApp.Shared.Models;
using System.Net.Http.Json;
using BlogApp.Frontend.Services;

namespace BlogApp.Frontend.Services;

public class UserService : IUserService
{
    private readonly HttpClient _httpClient;

    public UserService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    public async Task<User?> GetUserAsync(string id)
    {
        try
        {
            return await _httpClient.GetFromJsonAsync<User>($"api/user/{id}");
        }
        catch (Exception)
        {
            return null;
        }
    }

    public async Task<User> UpdateUserAsync(string id, UpdateUserRequest request)
    {
        var response = await _httpClient.PutAsJsonAsync($"api/user/{id}", request);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadFromJsonAsync<User>() ?? throw new Exception("Failed to update user");
    }

    public async Task<bool> FollowUserAsync(string userId)
    {
        try
        {
            var response = await _httpClient.PostAsync($"api/user/{userId}/follow", null);
            return response.IsSuccessStatusCode;
        }
        catch (Exception)
        {
            return false;
        }
    }

    public async Task<bool> UnfollowUserAsync(string userId)
    {
        try
        {
            var response = await _httpClient.DeleteAsync($"api/user/{userId}/follow");
            return response.IsSuccessStatusCode;
        }
        catch (Exception)
        {
            return false;
        }
    }

    public async Task<List<User>> GetFollowersAsync(string userId)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<List<User>>($"api/user/{userId}/followers");
            return response ?? new List<User>();
        }
        catch (Exception)
        {
            return new List<User>();
        }
    }

    public async Task<List<User>> GetFollowingAsync(string userId)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<List<User>>($"api/user/{userId}/following");
            return response ?? new List<User>();
        }
        catch (Exception)
        {
            return new List<User>();
        }
    }

    public async Task<List<User>> SearchUsersAsync(string query, int page = 1, int pageSize = 10)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<List<User>>($"api/user/search?query={query}&page={page}&pageSize={pageSize}");
            return response ?? new List<User>();
        }
        catch (Exception)
        {
            return new List<User>();
        }
    }

    public async Task<List<User>> GetSuggestedUsersAsync(string userId, int count = 10)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<List<User>>($"api/user/{userId}/suggested?count={count}");
            return response ?? new List<User>();
        }
        catch (Exception)
        {
            return new List<User>();
        }
    }
}
