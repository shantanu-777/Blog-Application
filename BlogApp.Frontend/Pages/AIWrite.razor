@page "/ai-write"
@attribute [Authorize]
@using BlogApp.Shared.Models.AI
@using BlogApp.Frontend.Components
@inject IAIContentService AIContentService
@inject IBlogService BlogService
@inject IAuthService AuthService
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>AI Write - BlogApp</PageTitle>

<div class="medium-ai-container">
    <div class="medium-ai-form">
        <h2 class="medium-ai-title">AI Content Generator</h2>
        <form>
            <div class="medium-ai-field">
                <label for="topic">Topic</label>
                <input id="topic" type="text" class="medium-ai-input" @bind="request.Topic" required />
            </div>
            <div class="medium-ai-field">
                <label for="context">Additional Context (Optional)</label>
                <textarea id="context" class="medium-ai-input" @bind="request.AdditionalContext" rows="3"></textarea>
            </div>
            <div class="medium-ai-field">
                <label for="type">Content Type</label>
                <select id="type" class="medium-ai-input" @bind="request.Type">
                    <option value="ContentType.BlogPost">Blog Post</option>
                    <option value="ContentType.Tutorial">Tutorial</option>
                    <option value="ContentType.Article">Article</option>
                    <option value="ContentType.News">News</option>
                    <option value="ContentType.Review">Review</option>
                    <option value="ContentType.Opinion">Opinion</option>
                </select>
            </div>
            <div class="medium-ai-field">
                <label for="style">Writing Style</label>
                <select id="style" class="medium-ai-input" @bind="request.Style">
                    <option value="WritingStyle.Professional">Professional</option>
                    <option value="WritingStyle.Casual">Casual</option>
                    <option value="WritingStyle.Academic">Academic</option>
                    <option value="WritingStyle.Creative">Creative</option>
                    <option value="WritingStyle.Technical">Technical</option>
                    <option value="WritingStyle.Conversational">Conversational</option>
                </select>
            </div>
            <div class="medium-ai-field">
                <label for="targetLength">Target Length (words)</label>
                <input id="targetLength" type="number" class="medium-ai-input" @bind="request.TargetLength" />
            </div>
            <div class="medium-ai-field">
                <label for="targetAudience">Target Audience (Optional)</label>
                <input id="targetAudience" type="text" class="medium-ai-input" @bind="request.TargetAudience" />
            </div>
            <div class="medium-ai-checkbox">
                <input id="includeImages" type="checkbox" @bind="request.IncludeImages" />
                <label for="includeImages">Include image suggestions</label>
            </div>
            <div class="medium-ai-checkbox">
                <input id="includeCodeExamples" type="checkbox" @bind="request.IncludeCodeExamples" />
                <label for="includeCodeExamples">Include code examples</label>
            </div>
            <button type="button" class="medium-btn medium-btn-primary medium-ai-btn" @onclick="GenerateContent" disabled="@isGenerating">
                @if (isGenerating)
                {
                    <span class="medium-auth-spinner"></span>
                }
                Generate Content
            </button>
        </form>
    </div>
    <div class="medium-ai-preview">
        @if (isGenerating)
        {
            <div class="medium-ai-loading">
                <span class="medium-auth-spinner"></span>
                <span>Generating your content...</span>
            </div>
        }
        else if (generatedContent != null)
        {
            <div class="medium-ai-content">
                <h3>@generatedContent.Title</h3>
                <div class="medium-ai-meta">
                    @if (!string.IsNullOrWhiteSpace(generatedContent.SEOOptimizedTitle))
                    {
                        <div>
                            <strong>SEO Title:</strong>
                            <p>@generatedContent.SEOOptimizedTitle</p>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(generatedContent.MetaDescription))
                    {
                        <div>
                            <strong>Meta Description:</strong>
                            <p>@generatedContent.MetaDescription</p>
                        </div>
                    }
                </div>
                <p>@generatedContent.Excerpt</p>
                <div class="medium-ai-tags">
                    @foreach (var tag in generatedContent.SuggestedTags)
                    {
                        <span class="medium-ai-tag">@tag</span>
                    }
                </div>
                @if (generatedContent.Outline?.Any() == true)
                {
                    <div class="medium-ai-outline">
                        <h4>Outline</h4>
                        <ol>
                            @foreach (var outlineItem in generatedContent.Outline)
                            {
                                <li>@outlineItem</li>
                            }
                        </ol>
                    </div>
                }
                <div class="medium-ai-body">
                    @((MarkupString)generatedContent.GeneratedContent.Replace("\n", "<br/>") )
                </div>
                @if (generatedContent.ImageSuggestions?.Any() == true)
                {
                    <div class="medium-ai-images">
                        <h4>Image Suggestions</h4>
                        <div class="medium-ai-image-list">
                            @foreach (var image in generatedContent.ImageSuggestions)
                            {
                                <div class="medium-ai-image-card">
                                    <img src="@image" alt="Suggestion" />
                                    <span>@image</span>
                                </div>
                            }
                        </div>
                    </div>
                }
                @if (generatedContent.RelatedTopics?.Any() == true)
                {
                    <div class="medium-ai-related">
                        <h4>Related Topics</h4>
                        <div class="medium-ai-tags">
                            @foreach (var topic in generatedContent.RelatedTopics)
                            {
                                <span class="medium-ai-tag">@topic</span>
                            }
                        </div>
                    </div>
                }
                <div class="medium-ai-actions">
                    <button type="button" class="medium-btn medium-btn-primary" @onclick="CreatePost">Publish AI Draft</button>
                    <button type="button" class="medium-btn medium-btn-secondary" @onclick="SendToEditor" disabled="@isSendingToEditor">
                        @(isSendingToEditor ? "Opening Editor..." : "Open in Editor")
                    </button>
                    <button type="button" class="medium-btn medium-btn-outline" @onclick="CopyContentToClipboard" disabled="@isCopying">
                        @(isCopying ? "Copying..." : "Copy Content")
                    </button>
                    <button type="button" class="medium-btn medium-btn-text" @onclick="RegenerateContent">Regenerate</button>
                </div>
            </div>
        }
        else
        {
            <div class="medium-ai-empty">
                <span>Fill in the form and click "Generate Content" to get started.</span>
            </div>
        }
    </div>
</div>

@code {
    private ContentGenerationRequest request = new();
    private ContentGenerationResponse? generatedContent;
    private bool isGenerating = false;
    private bool isCopying = false;
    private bool isSendingToEditor = false;
    private User? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
    }

    private async Task GenerateContent()
    {
        if (string.IsNullOrWhiteSpace(request.Topic)) return;
        isGenerating = true;
        try
        {
            generatedContent = await AIContentService.GenerateContentAsync(request);
            Snackbar.Add("Content generated successfully!", Severity.Success);
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to generate content. Please try again.", Severity.Error);
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task CreatePost()
    {
        if (generatedContent == null) return;
        if (currentUser == null)
        {
            Snackbar.Add("Please sign in to publish", Severity.Warning);
            return;
        }

        try
        {
            var createRequest = new CreatePostRequest
            {
                Title = generatedContent.Title,
                Excerpt = generatedContent.Excerpt,
                Content = generatedContent.GeneratedContent,
                Tags = generatedContent.SuggestedTags,
                Categories = generatedContent.SuggestedCategories,
                IsAIGenerated = true,
                AIPrompt = request.Topic,
                AuthorId = currentUser.Id
            };
            var post = await BlogService.CreatePostAsync(createRequest);
            Snackbar.Add("Post created successfully!", Severity.Success);
            Navigation.NavigateTo($"/post/{post.Slug}");
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to create post. Please try again.", Severity.Error);
        }
    }

    private async Task RegenerateContent()
    {
        await GenerateContent();
    }

    private async Task CopyContentToClipboard()
    {
        if (generatedContent == null) return;
        isCopying = true;
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", generatedContent.GeneratedContent);
            Snackbar.Add("Content copied to clipboard", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Unable to copy content", Severity.Error);
        }
        finally
        {
            isCopying = false;
        }
    }

    private async Task SendToEditor()
    {
        if (generatedContent == null)
            return;

        isSendingToEditor = true;
        try
        {
            var draft = new AiDraft
            {
                Title = generatedContent.Title,
                Content = generatedContent.GeneratedContent,
                Excerpt = generatedContent.Excerpt,
                FeaturedImageUrl = generatedContent.ImageSuggestions?.FirstOrDefault(),
                Tags = generatedContent.SuggestedTags,
                MetaDescription = generatedContent.MetaDescription
            };

            await LocalStorage.SetItemAsync("ai-draft", draft);
            Snackbar.Add("Draft sent to editor", Severity.Info);
            Navigation.NavigateTo("/write");
        }
        catch
        {
            Snackbar.Add("Unable to transfer draft to editor", Severity.Error);
        }
        finally
        {
            isSendingToEditor = false;
        }
    }
}

<style>
.medium-ai-container {
    display: flex;
    gap: 2rem;
    max-width: 1100px;
    margin: 2rem auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.03);
    padding: 2rem;
}
.medium-ai-form {
    flex: 1;
    padding-right: 2rem;
    border-right: 1px solid #eee;
}
.medium-ai-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
}
.medium-ai-field {
    margin-bottom: 1.2rem;
}
.medium-ai-field label {
    display: block;
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #222;
}
.medium-ai-input {
    width: 100%;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    border: 1px solid #eee;
    font-size: 1rem;
    background: #fafafa;
    color: #222;
    transition: border 0.2s;
}
.medium-ai-input:focus {
    border-color: #1a8917;
    outline: none;
}
.medium-ai-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    margin-bottom: 1rem;
}
.medium-ai-btn {
    width: 100%;
    margin-top: 0.5rem;
}
.medium-ai-preview {
    flex: 2;
    padding-left: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}
.medium-ai-loading {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.1rem;
    color: #1a8917;
    margin-top: 2rem;
}
.medium-ai-content {
    margin-top: 1rem;
    background: #fafafa;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 8px rgba(0,0,0,0.04);
}
.medium-ai-content h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}
.medium-ai-tags {
    margin-bottom: 1rem;
}
.medium-ai-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.medium-ai-outline {
    background: #fff;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border: 1px solid #eee;
}

.medium-ai-images {
    margin: 1.5rem 0;
}

.medium-ai-image-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
}

.medium-ai-image-card {
    background: #fff;
    border-radius: 12px;
    border: 1px solid #eee;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: 0.85rem;
    word-break: break-all;
}

.medium-ai-image-card img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    border-radius: 8px;
}

.medium-ai-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1.5rem;
}

.medium-btn.medium-btn-secondary {
    background: #0f172a;
    color: #fff;
}

.medium-ai-tag {
    display: inline-block;
    background: #1a8917;
    color: #fff;
.medium-btn.medium-btn-text {
    background: transparent;
    color: #1a8917;
    border: none;
}
    border-radius: 12px;
    padding: 0.2rem 0.8rem;
    font-size: 0.95rem;
    margin-right: 0.5rem;
    margin-bottom: 0.3rem;
}
.medium-ai-body {
    font-size: 1rem;
    color: #222;
    margin-bottom: 1.5rem;
    line-height: 1.7;
}
.medium-ai-actions {
    display: flex;
    gap: 1rem;
}
.medium-ai-empty {
    margin-top: 2rem;
    color: #888;
    font-size: 1.1rem;
}
.medium-auth-spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #eee;
    border-top: 2px solid #1a8917;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}
keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
