@page "/admin"
@inject IAdminService AdminService
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@using BlogApp.Shared.Models
@using MudBlazor

<div class="admin-layout">
    @if (notAuthorized)
    {
        <div class="admin-container">
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                You need administrator access to view this page.
            </MudAlert>
        </div>
    }
    else
    {
        <div class="admin-sidebar">
            <div class="admin-sidebar-header">
                <h2>Admin Panel</h2>
            </div>
            <nav class="admin-sidebar-nav">
                <button class="admin-nav-item @(activeSection == "overview" ? "active" : "")" @onclick='() => SetActiveSection("overview")'>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Overview</span>
                </button>
                <button class="admin-nav-item @(activeSection == "moderation" ? "active" : "")" @onclick='() => SetActiveSection("moderation")'>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    <span>Moderation</span>
                </button>
                <button class="admin-nav-item @(activeSection == "users" ? "active" : "")" @onclick='() => SetActiveSection("users")'>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Users</span>
                </button>
                <button class="admin-nav-item @(activeSection == "analytics" ? "active" : "")" @onclick='() => SetActiveSection("analytics")'>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    <span>Analytics</span>
                </button>
                <button class="admin-nav-item @(activeSection == "settings" ? "active" : "")" @onclick='() => SetActiveSection("settings")'>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364 6.364l-4.243-4.243m-4.242 0L5.636 17.364m12.728 0l-4.243-4.243m-4.242 0L5.636 6.636"></path>
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>
        </div>

        <div class="admin-main">
            @if (isLoading)
            {
                <div class="admin-loading">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else
            {
                @if (activeSection == "overview")
                {
                    @OverviewSection
                }
                else if (activeSection == "moderation")
                {
                    @ModerationSection
                }
                else if (activeSection == "users")
                {
                    @UsersSection
                }
                else if (activeSection == "analytics")
                {
                    @AnalyticsSection
                }
                else if (activeSection == "settings")
                {
                    @SettingsSection
                }
            }
        </div>
    }
</div>

@code {
    private AdminDashboardMetrics? dashboard;
    private AdminAnalyticsResponse? analytics;
    private PagedResult<BlogPost>? postQueue;
    private PagedResult<CommentModerationSummary>? commentQueue;
    private PagedResult<UserAdminSummary>? users;
    private SiteSettings settings = new();

    private readonly Dictionary<string, string?> reviewNotes = new();
    private readonly AdminPostFilter postFilter = new() { Status = PostStatus.PendingReview, PageSize = 10 };
    private readonly AdminCommentFilter commentFilter = new() { FlaggedOnly = true, PageSize = 8 };
    private readonly AdminUserFilter userFilter = new() { PageSize = 10 };

    private string postSearch = string.Empty;
    private string commentSearch = string.Empty;
    private string userSearch = string.Empty;
    private bool commentFlaggedOnly = true;
    private bool commentPendingOnly;
    private bool userActiveOnly;
    private bool isLoading = true;
    private bool moderationLoading;
    private bool usersLoading;
    private bool analyticsLoading;
    private bool savingSettings;
    private bool notAuthorized;
    private int analyticsRange = 30;
    private string activeSection = "overview";

    protected override async Task OnInitializedAsync()
    {
        var user = await AuthService.GetCurrentUserAsync();
        if (user?.Role != UserRole.Admin)
        {
            notAuthorized = true;
            isLoading = false;
            return;
        }

        await LoadAllAsync();
    }

    private void SetActiveSection(string section)
    {
        activeSection = section;
    }

    private async Task LoadAllAsync()
    {
        dashboard = await AdminService.GetDashboardMetricsAsync();
        settings = await AdminService.GetSiteSettingsAsync() ?? new SiteSettings();
        analytics = await AdminService.GetAnalyticsAsync(analyticsRange);
        await LoadModerationAsync();
        await LoadUsersAsync();
        commentFlaggedOnly = commentFilter.FlaggedOnly ?? true;
        commentPendingOnly = commentFilter.PendingApprovalOnly ?? false;
        userActiveOnly = userFilter.IsActive ?? false;
        isLoading = false;
    }

    private async Task LoadModerationAsync()
    {
        moderationLoading = true;
        postQueue = await AdminService.GetModerationPostsAsync(postFilter);
        commentQueue = await AdminService.GetModerationCommentsAsync(commentFilter);
        dashboard = await AdminService.GetDashboardMetricsAsync();
        commentFlaggedOnly = commentFilter.FlaggedOnly ?? false;
        commentPendingOnly = commentFilter.PendingApprovalOnly ?? false;
        moderationLoading = false;
    }

    private async Task LoadUsersAsync()
    {
        usersLoading = true;
        users = await AdminService.GetUsersAsync(userFilter);
        userActiveOnly = userFilter.IsActive ?? false;
        usersLoading = false;
    }

    private async Task LoadAnalyticsAsync()
    {
        analyticsLoading = true;
        analytics = await AdminService.GetAnalyticsAsync(analyticsRange);
        analyticsLoading = false;
    }

    private RenderFragment OverviewSection => (__builder) =>
    {
        <div class="admin-section">
            <h1 class="admin-section-title">Dashboard Overview</h1>
            
            <div class="admin-metrics-grid">
                <div class="admin-metric-card">
                    <div class="admin-metric-icon" style="background: #e3f2fd;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </div>
                    <div class="admin-metric-content">
                        <div class="admin-metric-value">@(dashboard?.TotalPosts ?? 0)</div>
                        <div class="admin-metric-label">Total Posts</div>
                    </div>
                </div>

                <div class="admin-metric-card">
                    <div class="admin-metric-icon" style="background: #fff3e0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="admin-metric-content">
                        <div class="admin-metric-value">@(dashboard?.PendingPosts ?? 0)</div>
                        <div class="admin-metric-label">Pending Posts</div>
                    </div>
                </div>

                <div class="admin-metric-card">
                    <div class="admin-metric-icon" style="background: #e1f5fe;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0288d1" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="admin-metric-content">
                        <div class="admin-metric-value">@(dashboard?.PendingComments ?? 0)</div>
                        <div class="admin-metric-label">Pending Comments</div>
                    </div>
                </div>

                <div class="admin-metric-card">
                    <div class="admin-metric-icon" style="background: #e8f5e9;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="admin-metric-content">
                        <div class="admin-metric-value">@((int)((dashboard?.EngagementRate ?? 0) * 100))%</div>
                        <div class="admin-metric-label">Engagement Rate</div>
                    </div>
                </div>
            </div>

            <div class="admin-content-grid">
                <div class="admin-card">
                    <h3 class="admin-card-title">Recent Activity</h3>
                    @if (dashboard?.PostTrends?.Any() == true)
                    {
                        <MudTable Items="dashboard.PostTrends" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh class="text-center">Posts</MudTh>
                                <MudTh class="text-center">Views</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Date.ToString("MMM dd")</MudTd>
                                <MudTd Class="text-center">@context.Posts</MudTd>
                                <MudTd Class="text-center">@context.Views</MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <p class="admin-empty">No analytics data yet.</p>
                    }
                </div>

                <div class="admin-card">
                    <h3 class="admin-card-title">Latest Members</h3>
                    @if (dashboard?.LatestMembers?.Any() == true)
                    {
                        <MudList Dense="true">
                            @foreach (var member in dashboard.LatestMembers)
                            {
                                <MudListItem>
                                    <div class="admin-member-item">
                                        <MudText Typo="Typo.subtitle2">@(member.DisplayName ?? member.Username)</MudText>
                                        <MudText Typo="Typo.caption">@member.Email</MudText>
                                        <MudChip Color="Color.Primary" Size="Size.Small" Class="mt-1">@member.Role</MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <p class="admin-empty">No new members yet.</p>
                    }
                </div>
            </div>
        </div>;
    };

    private RenderFragment ModerationSection => (__builder) =>
    {
        <div class="admin-section">
            <h1 class="admin-section-title">Content Moderation</h1>
            
            <div class="admin-filters">
                <MudSelect T="PostStatus?" Value="@postFilter.Status" ValueChanged="@(async (PostStatus? status) => await OnPostStatusChanged(status))" Label="Status" Dense="true" Variant="Variant.Outlined" Style="min-width: 200px;">
                    <MudSelectItem Value="@((PostStatus?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@PostStatus.PendingReview">Pending Review</MudSelectItem>
                    <MudSelectItem Value="@PostStatus.Draft">Draft</MudSelectItem>
                    <MudSelectItem Value="@PostStatus.Published">Published</MudSelectItem>
                </MudSelect>

                <MudTextField @bind-Value="postSearch" Placeholder="Search posts" Variant="Variant.Outlined" Dense="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Style="flex: 1; max-width: 400px;" />

                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyPostFilterAsync">Apply</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" Disabled="@moderationLoading" OnClick="LoadModerationAsync">Refresh</MudButton>
            </div>

            <div class="admin-content-grid">
                <div class="admin-card" style="grid-column: 1 / -1;">
                    <h3 class="admin-card-title">Posts Queue</h3>
                    @if (moderationLoading)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
                    }
                    <MudTable Items="postQueue?.Items ?? new List<BlogPost>()" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Title</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Notes</MudTh>
                            <MudTh class="text-right">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudText Typo="Typo.subtitle2">@context.Title</MudText>
                                <MudText Typo="Typo.caption">@context.AuthorId</MudText>
                            </MudTd>
                            <MudTd>
                                <MudChip Color="GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
                            </MudTd>
                            <MudTd>
                                <MudTextField Value="GetReviewNote(context.Id)"
                                              ValueChanged="@((string? value) => OnReviewNoteChanged(context.Id, value))"
                                              Variant="Variant.Outlined"
                                              Dense="true"
                                              Placeholder="Add note" />
                            </MudTd>
                            <MudTd Class="text-right">
                                <MudButton Size="Size.Small" Color="Color.Success" Variant="Variant.Filled" OnClick="() => ModeratePostAsync(context, PostStatus.Published)">
                                    Publish
                                </MudButton>
                                <MudButton Size="Size.Small" Color="Color.Warning" Variant="Variant.Text" Class="ml-1" OnClick="() => ModeratePostAsync(context, PostStatus.Draft)">
                                    Send Back
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>

                <div class="admin-card">
                    <h3 class="admin-card-title">Comments Moderation</h3>
                    <div class="admin-filters" style="flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                        <MudSwitch Value="@commentFlaggedOnly" ValueChanged="@(async (bool value) => await OnCommentFlaggedChanged(value))" Color="Color.Primary" Label="Flagged only" />
                        <MudSwitch Value="@commentPendingOnly" ValueChanged="@(async (bool value) => await OnCommentPendingChanged(value))" Color="Color.Primary" Label="Pending approval" />
                        <MudTextField @bind-Value="commentSearch" Placeholder="Search comments" Variant="Variant.Outlined" Dense="true" />
                        <MudButton Variant="Variant.Text" OnClick="ApplyCommentFilterAsync">Apply</MudButton>
                    </div>
                    @if (moderationLoading)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
                    }
                    @if (commentQueue?.Items?.Any() == true)
                    {
                        <MudList Dense="true">
                            @foreach (var comment in commentQueue.Items)
                            {
                                <MudListItem Class="mb-2">
                                    <div class="admin-comment-item">
                                        <MudText Typo="Typo.subtitle2">@comment.AuthorId</MudText>
                                        <MudText Typo="Typo.body2">@comment.Content</MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">@comment.CreatedAt.ToLocalTime().ToString("g")</MudText>
                                        <div class="admin-comment-actions">
                                            <MudButton Size="Size.Small" Color="Color.Success" Variant="Variant.Text" OnClick="() => ModerateCommentAsync(comment.Id, true, false)">Approve</MudButton>
                                            <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Text" OnClick="() => ModerateCommentAsync(comment.Id, false, true)">Delete</MudButton>
                                            <MudButton Size="Size.Small" Color="Color.Warning" Variant="Variant.Text" OnClick="() => ModerateCommentAsync(comment.Id, false, false)">Keep Flagged</MudButton>
                                        </div>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <p class="admin-empty">No comments require attention.</p>
                    }
                </div>
            </div>
        </div>;
    };

    private RenderFragment UsersSection => (__builder) =>
    {
        <div class="admin-section">
            <h1 class="admin-section-title">User Management</h1>
            
            <div class="admin-filters">
                <MudTextField @bind-Value="userSearch" Placeholder="Search users" Variant="Variant.Outlined" Dense="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Style="flex: 1; max-width: 400px;" />
                <MudSelect T="UserRole?" Value="@userFilter.Role" ValueChanged="@(async (UserRole? role) => await OnUserRoleFilterChanged(role))" Dense="true" Label="Role" Variant="Variant.Outlined" Style="min-width: 200px;">
                    <MudSelectItem Value="@((UserRole?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@UserRole.Reader">Reader</MudSelectItem>
                    <MudSelectItem Value="@UserRole.Author">Author</MudSelectItem>
                    <MudSelectItem Value="@UserRole.Editor">Editor</MudSelectItem>
                    <MudSelectItem Value="@UserRole.Admin">Admin</MudSelectItem>
                </MudSelect>
                <MudSwitch Value="@userActiveOnly" ValueChanged="@(async (bool value) => await OnUserActiveChanged(value))" Color="Color.Primary" Label="Active only" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyUserFilterAsync">Apply</MudButton>
            </div>

            <div class="admin-card">
                @if (usersLoading)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
                }
                <MudTable Items="users?.Items ?? new List<UserAdminSummary>()" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>User</MudTh>
                        <MudTh>Role</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Joined</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudText Typo="Typo.subtitle2">@(context.DisplayName ?? context.Username)</MudText>
                            <MudText Typo="Typo.caption">@context.Email</MudText>
                        </MudTd>
                        <MudTd>
                            <MudSelect T="UserRole" Value="@context.Role" ValueChanged="@(async (UserRole role) => await ChangeUserRoleAsync(context, role))" Dense="true" Variant="Variant.Outlined">
                                <MudSelectItem Value="@UserRole.Reader">Reader</MudSelectItem>
                                <MudSelectItem Value="@UserRole.Author">Author</MudSelectItem>
                                <MudSelectItem Value="@UserRole.Editor">Editor</MudSelectItem>
                                <MudSelectItem Value="@UserRole.Admin">Admin</MudSelectItem>
                            </MudSelect>
                        </MudTd>
                        <MudTd>
                            <MudSwitch Value="@context.IsActive" ValueChanged="@(async (bool value) => await ToggleUserStatusAsync(context, value))" Color="Color.Success" />
                        </MudTd>
                        <MudTd>@context.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        </div>;
    };

    private RenderFragment AnalyticsSection => (__builder) =>
    {
        <div class="admin-section">
            <h1 class="admin-section-title">Analytics</h1>
            
            <div class="admin-filters">
                <MudSlider @bind-Value="analyticsRange" Min="7" Max="90" Step="7" Label="Range (days)" Immediate="true" Style="flex: 1; max-width: 300px;" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@analyticsLoading" OnClick="LoadAnalyticsAsync">
                    Refresh
                </MudButton>
            </div>
            
            @if (analyticsLoading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
            }
            
            <div class="admin-content-grid">
                <div class="admin-card">
                    <h3 class="admin-card-title">Views Trend</h3>
                    @if (analytics?.ViewsTrend?.Any() == true)
                    {
                        <MudTable Items="analytics.ViewsTrend" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh>Posts</MudTh>
                                <MudTh>Views</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Date.ToString("MMM dd")</MudTd>
                                <MudTd>@context.Posts</MudTd>
                                <MudTd>@context.Views</MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <p class="admin-empty">No analytics data.</p>
                    }
                </div>

                <div class="admin-card">
                    <h3 class="admin-card-title">Top Posts</h3>
                    @if (analytics?.TopPosts?.Any() == true)
                    {
                        <MudList Dense="true">
                            @foreach (var post in analytics.TopPosts)
                            {
                                <MudListItem>
                                    <div>
                                        <MudText Typo="Typo.subtitle2">@post.Title</MudText>
                                        <MudText Typo="Typo.caption">@post.Views views · @post.Likes likes · @post.Comments comments</MudText>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <p class="admin-empty">No post engagement yet.</p>
                    }
                </div>

                <div class="admin-card">
                    <h3 class="admin-card-title">Category Breakdown</h3>
                    @if (analytics?.CategoryDistribution?.Any() == true)
                    {
                        @foreach (var category in analytics.CategoryDistribution)
                        {
                            <div class="admin-category-item">
                                <MudText Typo="Typo.subtitle2">@category.Category (@category.Posts)</MudText>
                                <MudProgressLinear Value="@GetCategoryPercentage(category.Posts)" Color="Color.Primary" />
                            </div>
                        }
                    }
                    else
                    {
                        <p class="admin-empty">No categories recorded.</p>
                    }
                </div>
            </div>
        </div>;
    };

    private RenderFragment SettingsSection => (__builder) =>
    {
        <div class="admin-section">
            <h1 class="admin-section-title">Site Settings</h1>
            
            <div class="admin-card">
                <EditForm Model="settings" OnValidSubmit="SaveSettingsAsync">
                    <DataAnnotationsValidator />
                    <div class="admin-settings-grid">
                        <MudTextField @bind-Value="settings.SiteTitle" Label="Site Title" Required="true" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.SiteUrl" Label="Site URL" Required="true" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.ContactEmail" Label="Contact Email" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.SiteDescription" Label="Description" Lines="3" Variant="Variant.Outlined" Style="grid-column: 1 / -1;" />
                        <MudTextField @bind-Value="settings.PrimaryColor" Label="Primary Color" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.SecondaryColor" Label="Secondary Color" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.ThemeColor" Label="Accent" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.GoogleAnalyticsId" Label="Google Analytics ID" Variant="Variant.Outlined" />
                        <MudTextField @bind-Value="settings.FacebookPixelId" Label="Facebook Pixel ID" Variant="Variant.Outlined" />
                    </div>
                    <div class="admin-settings-switches">
                        <MudSwitch @bind-Value="settings.AllowComments" Color="Color.Primary" Label="Allow Comments" />
                        <MudSwitch @bind-Value="settings.RequireCommentApproval" Color="Color.Primary" Label="Require Approval" />
                        <MudSwitch @bind-Value="settings.EnableNewsletter" Color="Color.Primary" Label="Newsletter" />
                        <MudSwitch @bind-Value="settings.EnableSearch" Color="Color.Primary" Label="Search" />
                    </div>
                    <div class="admin-settings-actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="savingSettings" Type="Submit">
                            @if (savingSettings)
                            {
                                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                            }
                            Save Settings
                        </MudButton>
                    </div>
                </EditForm>
            </div>
        </div>;
    };

    private async Task ApplyPostFilterAsync()
    {
        postFilter.Search = postSearch;
        await LoadModerationAsync();
    }

    private async Task OnPostStatusChanged(PostStatus? status)
    {
        postFilter.Status = status;
        await ApplyPostFilterAsync();
    }

    private async Task ApplyCommentFilterAsync()
    {
        commentFilter.Search = commentSearch;
        commentFilter.FlaggedOnly = commentFlaggedOnly ? true : (bool?)null;
        commentFilter.PendingApprovalOnly = commentPendingOnly ? true : (bool?)null;
        await LoadModerationAsync();
    }

    private async Task OnCommentFlaggedChanged(bool value)
    {
        commentFlaggedOnly = value;
        await ApplyCommentFilterAsync();
    }

    private async Task OnCommentPendingChanged(bool value)
    {
        commentPendingOnly = value;
        await ApplyCommentFilterAsync();
    }

    private async Task ApplyUserFilterAsync()
    {
        userFilter.Search = userSearch;
        userFilter.IsActive = userActiveOnly ? true : (bool?)null;
        await LoadUsersAsync();
    }

    private async Task OnUserRoleFilterChanged(UserRole? role)
    {
        userFilter.Role = role;
        await ApplyUserFilterAsync();
    }

    private async Task OnUserActiveChanged(bool value)
    {
        userActiveOnly = value;
        await ApplyUserFilterAsync();
    }

    private async Task ModeratePostAsync(BlogPost post, PostStatus status)
    {
        var note = GetReviewNote(post.Id);
        var success = await AdminService.UpdatePostStatusAsync(post.Id, status, note);
        if (success)
        {
            Snackbar.Add($"Updated '{post.Title}'", Severity.Success);
            await LoadModerationAsync();
        }
        else
        {
            Snackbar.Add("Unable to update post status.", Severity.Error);
        }
    }

    private async Task ModerateCommentAsync(string commentId, bool approve, bool delete)
    {
        var request = new CommentModerationRequest { Approve = approve, Delete = delete };
        var success = await AdminService.ModerateCommentAsync(commentId, request);
        if (success)
        {
            Snackbar.Add("Comment moderation saved.", Severity.Success);
            await LoadModerationAsync();
        }
        else
        {
            Snackbar.Add("Unable to moderate comment.", Severity.Error);
        }
    }

    private async Task ChangeUserRoleAsync(UserAdminSummary user, UserRole newRole)
    {
        if (newRole == user.Role)
            return;

        var success = await AdminService.UpdateUserRoleAsync(user.Id, newRole);
        if (success)
        {
            Snackbar.Add($"Updated {user.Username} to {newRole}", Severity.Success);
            await LoadUsersAsync();
        }
        else
        {
            Snackbar.Add("Unable to update user role.", Severity.Error);
        }
    }

    private async Task ToggleUserStatusAsync(UserAdminSummary user, bool newStatus)
    {
        if (newStatus == user.IsActive)
            return;

        var success = await AdminService.UpdateUserStatusAsync(user.Id, newStatus);
        if (success)
        {
            user.IsActive = newStatus;
            Snackbar.Add($"User {(newStatus ? "activated" : "deactivated")}.", Severity.Info);
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            Snackbar.Add("Unable to update user status.", Severity.Error);
            await LoadUsersAsync();
        }
    }

    private async Task SaveSettingsAsync()
    {
        savingSettings = true;
        var updated = await AdminService.UpdateSiteSettingsAsync(settings);
        savingSettings = false;

        if (updated != null)
        {
            settings = updated;
            Snackbar.Add("Site settings updated.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Unable to save settings.", Severity.Error);
        }
    }

    private string? GetReviewNote(string postId)
        => reviewNotes.TryGetValue(postId, out var note) ? note : null;

    private void OnReviewNoteChanged(string postId, string? value)
    {
        reviewNotes[postId] = value;
    }

    private Color GetStatusColor(PostStatus status) => status switch
    {
        PostStatus.Published => Color.Success,
        PostStatus.PendingReview => Color.Warning,
        PostStatus.Draft => Color.Info,
        _ => Color.Default
    };

    private double GetCategoryPercentage(int value)
    {
        var total = analytics?.CategoryDistribution?.Sum(c => c.Posts) ?? 0;
        if (total == 0) return 0;
        return Math.Round(value * 100.0 / total, 2);
    }
}

<style>
.admin-layout {
    display: flex;
    min-height: calc(100vh - 60px);
    background: #f5f5f5;
}

.admin-sidebar {
    width: 260px;
    background: #fff;
    border-right: 1px solid #e1e5e9;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 60px;
    height: calc(100vh - 60px);
    overflow-y: auto;
}

.admin-sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e1e5e9;
}

.admin-sidebar-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
}

.admin-sidebar-nav {
    display: flex;
    flex-direction: column;
    padding: 0.5rem;
}

.admin-nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: none;
    background: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
    font-size: 0.9375rem;
    font-weight: 500;
    text-align: left;
    width: 100%;
}

.admin-nav-item:hover {
    background: #f6f8fa;
    color: #1a8917;
}

.admin-nav-item.active {
    background: #e8f5e9;
    color: #1a8917;
    font-weight: 600;
}

.admin-main {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
}

.admin-section {
    max-width: 1400px;
}

.admin-section-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 2rem 0;
    color: #333;
}

.admin-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.admin-metric-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.admin-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.admin-metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.admin-metric-content {
    flex: 1;
}

.admin-metric-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #333;
    line-height: 1.2;
}

.admin-metric-label {
    font-size: 0.875rem;
    color: #666;
    margin-top: 0.25rem;
}

.admin-content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.admin-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.admin-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: #333;
}

.admin-filters {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.admin-empty {
    color: #999;
    text-align: center;
    padding: 2rem;
    margin: 0;
}

.admin-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
}

.admin-member-item {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.admin-comment-item {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 0.5rem;
}

.admin-comment-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.admin-category-item {
    margin-bottom: 1rem;
}

.admin-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.admin-settings-switches {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f6f8fa;
    border-radius: 8px;
}

.admin-settings-actions {
    display: flex;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid #e1e5e9;
}

.admin-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

@@media (max-width: 1024px) {
    .admin-layout {
        flex-direction: column;
    }
    
    .admin-sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        border-right: none;
        border-bottom: 1px solid #e1e5e9;
    }
    
    .admin-sidebar-nav {
        flex-direction: row;
        overflow-x: auto;
        padding: 0.5rem;
    }
    
    .admin-nav-item {
        white-space: nowrap;
        min-width: fit-content;
    }
    
    .admin-main {
        padding: 1rem;
    }
    
    .admin-content-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}
</style>
